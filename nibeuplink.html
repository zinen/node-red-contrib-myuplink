<script type="text/javascript">
    RED.nodes.registerType('nibeuplink-config',{
        category: 'config',
        defaults: {
            name: {value:""},
            authCodeDone: {value:false}
        },
        credentials: {
            clientId: {type:"text"},
            clientSecret: {type:"password"},
            systemId: {type:"text"},
            authCode: {value:"password"}
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            let defaultName="nibe uplink config"
            if (!this.authCodeDone) {
                defaultName += " (missing auth code)"
            }
            return defaultName;
        },
        oneditsave: function () {
            if ($("#node-config-input-clientId").val() && $("#node-config-input-authCode").val()) {
                this.authCodeDone = true
                return 
            } else if ($("#node-config-input-clientId").val()){
                window.open(`https://api.nibeuplink.com/oauth/authorize?response_type=code&client_id=${this.credentials.clientId}&scope=READSYSTEM&redirect_uri=http%3A%2F%2Fz0mt3c.github.io%2Fnibe.html&state=init`, '_blank')
            }
            this.authCodeDone = false
        }
    });
</script>

<script type="text/html" data-template-name="nibeuplink-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-user"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Optional name">
    </div>
    <div class="form-row">
    <div class="form-tips"><p>To get a client login you need to register an application at <a href="https://api.nibeuplink.com/" target="_blank">api.nibeuplink.com</a></p>
    <p>Give your application a name and description. Callback URL needs to be http://z0mt3c.github.io/nibe.html</p></div>
    </div>
    <div class="form-row">
        <label for="node-config-input-clientId"><i class="fa fa-user"></i> Client Identifier</label>
        <input type="text" id="node-config-input-clientId" placeholder="jlk12341hasd2224">
    </div>
    <div class="form-row">
        <label for="node-config-input-clientSecret"><i class="fa fa-key"></i> Client secret</label>
        <input type="password" id="node-config-input-clientSecret" placeholder="asdagf34263st4erfs213qas" autocomplete="off">
    </div>
    <div class="form-row">
    <div class="form-tips">Get your system id at <a href="https://nibeuplink.com/" target="_blank">nibeuplink.com</a> enter status page of unit and find system id in URL like X inside https://nibeuplink.com/System/X/Status/Overview
    </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-systemId"><i class="fa fa-globe"></i> System ID</label>
        <input type="text" id="node-config-input-systemId" placeholder="64087" autocomplete="off">
    </div>
    <div class="form-row">
    <div class="form-tips">Leave auth code empty at first run go get the URL needed to authenticate. You will be directed from api.nibeuplink.com back to the defined Callback URL mentioned above. The Callback URL will reveal your auth code
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-authCode"><i class="fa fa-key"></i> authCode</label>
        <input type="password" id="node-config-input-authCode" placeholder="should be empty at first run" autocomplete="off">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nibeuplink',{
        category: 'request',
        color: '#e55050',
        defaults: {
            name: {value:""},
            server: {type:"nibeuplink-config", required:true},
        },
        inputs:1,
        outputs:1,
        icon: "white-globe.png",
        label: function() {
            return this.name ||"NIBE Uplink";
        }
    });
</script>


<script type="text/html" data-template-name="nibeuplink">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-user"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional name">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-server" placeholder="Optional name">
    </div>
</script>

<script type="text/html" data-help-name="nibeuplink">
    <p>A Node-Red Node for collecting data from nibe uplink.</p>
    <h3>Inputs</h3>
    <p> Any </p>
    <h3>Output</h3>
    <p> Return object with raw API data</p>
</script>